

#========================================================
#=====================iHeater cfg========================
#========================================================

#=====================iHeater pins=======================
[board_pins]
mcu: iHeater
aliases:
    TH0=PA3, TH1=PA0,
    HEATER=PA1, FAN=PA2,
    MODE=PA4,
    LED1=PA7, LED2=PA6, LED3=PA5,
    USART1_TX=PA9, USART1_RX=PA10


#=====================iHeater mcu=======================
# [mcu]
# #[mcu iHeater] #second MCU
# serial: /dev/serial/by-id/usb-Klipper_stm32f042x6_0C0018000D53304347373020-if00 

[mcu iHeater] #second MCU
is_non_critical: true # flag this as non critical
serial: /dev/serial/by-id/usb-Klipper_stm32f042x6_430018000E53304347373020-if00
restart_method: command

#===========================================================
#====================== iHeater CONFIG =====================
#===========================================================

# üëâ Make sure to perform PID calibration for the chamber heater:
#üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•
#     PID_CALIBRATE HEATER=iHeater_H TARGET=60
#üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•
# This is essential for accurate and stable chamber heating.
# Without PID tuning, the temperature may overshoot or take too long to stabilize!
#
#===========================================================
[heater_generic iHeater_H]
heater_pin: iHeater:HEATER
max_power: 1
control: pid
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: iHeater:TH0
pwm_cycle_time: 0.3
min_temp: 0
max_temp: 120
pid_Kp=32.923
pid_Ki=5.628
pid_Kd=48.150

[verify_heater iHeater_H]
max_error: 240
check_gain_time: 120
heating_gain: 1

[heater_fan chamber_heater_fan]
pin: iHeater:FAN
heater: iHeater_H
heater_temp: 45.0
fan_speed: 1.0
shutdown_speed: 0
kick_start_time: 0.5

[temperature_sensor iHeater_Chamber]
sensor_pin: iHeater:TH1
sensor_type: NTC 100K MGB18-104F39050L32
min_temp: 0
max_temp: 140

[gcode_button mode_button]
pin: iHeater:MODE
# debounce_delay: 50
press_gcode: iHEATER_OFF

[output_pin led_1]
pin: iHeater: LED1

[output_pin led_2]
pin: iHeater: LED2

[output_pin led_3]
pin: iHeater: LED3

#######################################################
##########################SETUP########################
#######################################################

[gcode_macro CHAMBER_VARS]
variable_chamber_target: 0        # —Ü–µ–ª–µ–≤–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∫–∞–º–µ—Ä—ã
variable_delta_temp: 10           # –¥–µ–ª—å—Ç–∞ –º–µ–∂–¥—É –∫–∞–º–µ—Ä–æ–π –∏ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª–µ–º
variable_heater_target: 0         # —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –¥–æ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ –≥—Ä–µ—Ç—å –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—å
variable_max_heater_temp: 100     # –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ delta = 0)
gcode:

##########################MACRO########################

[gcode_macro M141]
#rename_existing: M141.1
gcode:
    # –ü–æ–ª—É—á–∞–µ–º –∂–µ–ª–∞–µ–º—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∫–∞–º–µ—Ä—ã –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ S, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60¬∞C
    {% set chamber_temp = params.S|default(60)|int %}
    # –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–æ–π –¥–µ–ª—å—Ç—ã:
    # - –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä D ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    # - –∏–Ω–∞—á–µ –±–µ—Ä—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ delta_temp –∏–∑ CHAMBER_VARS
    {% set delta = params.D|default(printer["gcode_macro CHAMBER_VARS"].delta_temp)|int %}
    # –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è:
    # - –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä H ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    # - –∏–Ω–∞—á–µ –±–µ—Ä—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ max_heater_temp –∏–∑ CHAMBER_VARS
    {% set max_temp = params.H|default(printer["gcode_macro CHAMBER_VARS"].max_heater_temp)|int %}

    # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 0 ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º –Ω–∞–≥—Ä–µ–≤
    {% if chamber_temp == 0 %}
        MACRO=iHEATER_OFF
        RESPOND prefix="M141" msg="–ù–∞–≥—Ä–µ–≤ –∫–∞–º–µ—Ä—ã –æ—Ç–∫–ª—é—á—ë–Ω (S=0)"

    {% else %}

        {% if chamber_temp < 0 %}
            RESPOND TYPE=error MSG="–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∫–∞–º–µ—Ä—ã (–Ω–∏–∂–µ 0¬∞C). –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é."
            {% set chamber_temp = 60 %}
        {% endif %}    

        # –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–ª–µ–≤—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è:
        # - –µ—Å–ª–∏ –¥–µ–ª—å—Ç–∞ –±–æ–ª—å—à–µ 0 ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º chamber_temp + delta
        # - –∏–Ω–∞—á–µ –≥—Ä–µ–µ–º –¥–æ max_temp –Ω–∞–ø—Ä—è–º—É—é
        # {% if delta > 0 %}
        #     {% set heater_target = chamber_temp + delta %}
        # {% else %}
        #     {% set heater_target = max_temp %}
        # {% endif %}
        {% set heater_target = max_temp %}

        {% if heater_target > max_temp %}
            RESPOND TYPE=warning MSG="–¶–µ–ª–µ–≤–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –¥–æ {max_temp}¬∞C"
            {% set heater_target = max_temp %}
        {% endif %}
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è
        SET_HEATER_TEMPERATURE HEATER=iHeater_H TARGET={heater_target}

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ CHAMBER_VARS –¥–ª—è delayed_gcode
        SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=heater_target VALUE={heater_target}
        SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=chamber_target VALUE={chamber_temp}
        SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=delta_temp VALUE={delta}
        # –ó–∞–ø—É—Å–∫–∞–µ–º –º–∞–∫—Ä–æ—Å –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã, –µ—Å–ª–∏ –æ–Ω –µ—â—ë –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        UPDATE_DELAYED_GCODE ID=_iHEATER_CONTROL DURATION=1    
    {% endif %}
    

[gcode_macro M191]
#rename_existing: M191.1
gcode:
    # –ü–æ–ª—É—á–∞–µ–º –∂–µ–ª–∞–µ–º—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –≤–æ–∑–¥—É—Ö–∞ –≤ –∫–∞–º–µ—Ä–µ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ S, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60¬∞C
    {% set chamber_temp = params.S|default(60)|int %}
    {% set delta = params.D|default(printer["gcode_macro CHAMBER_VARS"].delta_temp)|int %}
    {% set max_temp = params.H|default(printer["gcode_macro CHAMBER_VARS"].max_heater_temp)|int %}

    # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 0 ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º –Ω–∞–≥—Ä–µ–≤
    {% if chamber_temp == 0 %}
        MACRO=iHEATER_OFF
        RESPOND prefix="M191" msg="–ù–∞–≥—Ä–µ–≤ –∫–∞–º–µ—Ä—ã –æ—Ç–∫–ª—é—á—ë–Ω (S=0)"
    {% else %}

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É
        {% if chamber_temp < 0 %}
            RESPOND TYPE=error MSG="–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∫–∞–º–µ—Ä—ã (–Ω–∏–∂–µ 0¬∞C). –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60¬∞C."
            {% set chamber_temp = 60 %}
        {% endif %}    

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è
        # {% if delta > 0 %}
        #     {% set heater_target = chamber_temp + delta %}
        # {% else %}
        #     {% set heater_target = max_temp %}
        # {% endif %}
        {% set heater_target = max_temp %}

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        {% if heater_target > max_temp %}
            RESPOND TYPE=warning MSG="–¶–µ–ª–µ–≤–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –¥–æ {max_temp}¬∞C"
            {% set heater_target = max_temp %}
        {% endif %}

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è
        SET_HEATER_TEMPERATURE HEATER=iHeater_H TARGET={heater_target}

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ CHAMBER_VARS –¥–ª—è delayed_gcode
        SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=heater_target VALUE={heater_target}
        SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=chamber_target VALUE={chamber_temp}
        SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=delta_temp VALUE={delta}

        # –ó–∞–ø—É—Å–∫–∞–µ–º delayed_gcode –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        UPDATE_DELAYED_GCODE ID=_iHEATER_CONTROL DURATION=1

        # –ñ–¥—ë–º, –ø–æ–∫–∞ –∫–∞–º–µ—Ä–∞ —Ä–µ–∞–ª—å–Ω–æ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        TEMPERATURE_WAIT SENSOR=iHeater_Chamber MINIMUM={chamber_temp}
        RESPOND prefix="M191" msg="–ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç–∏–≥–ª–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã {chamber_temp}¬∞C"
    {% endif %}


[gcode_macro iHEATER_ON]
description: –ü—Å–µ–≤–¥–æ–Ω–∏–º –∫–æ–º–∞–Ω–¥—ã M141 —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
gcode:
    {% set s = params.CHAMBER_TEMP|default(60)|int %}
    {% set d = params.DELTA|default(printer["gcode_macro CHAMBER_VARS"].delta_temp)|int %}
    {% set h = params.HEATER_MAX|default(printer["gcode_macro CHAMBER_VARS"].max_heater_temp)|int %}

    M141 S{s} D{d} H{h}


[gcode_macro iHEATER_OFF]
gcode:
    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=heater_target VALUE=0
    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=chamber_target VALUE=0
    SET_HEATER_TEMPERATURE HEATER=iHeater_H TARGET=0
    UPDATE_DELAYED_GCODE ID=_iHEATER_CONTROL DURATION=1
    RESPOND prefix="CHAMBER_HEATER_OFF" msg="–ù–∞–≥—Ä–µ–≤ –æ—Ç–∫–ª—é—á—ë–Ω. –û–∂–∏–¥–∞–µ–º –æ—Ö–ª–∞–∂–¥–µ–Ω–∏–µ –¥–æ 50¬∞C."


[delayed_gcode _iHEATER_CONTROL]
gcode:
    # –¶–µ–ª–µ–≤–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∫–∞–º–µ—Ä—ã
    {% set target_chamber_temp = printer["gcode_macro CHAMBER_VARS"].chamber_target|default(0)|float %}

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É, –¥–æ –∫–æ—Ç–æ—Ä–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–≥—Ä–µ—Ç –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—å
    {% set target_heater_temp = printer["gcode_macro CHAMBER_VARS"].heater_target|default(0)|float %}

    # –î–µ–ª—å—Ç–∞ ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è –ø—Ä–µ–≤—ã—à–∞–µ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∫–∞–º–µ—Ä—ã
    {% set delta = printer["gcode_macro CHAMBER_VARS"].delta_temp|default(0)|float %}

    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã –∏–ª–∏ fallback –ª–æ–≥–∏–∫–∏)
    {% set max_heater_temp = printer["gcode_macro CHAMBER_VARS"].max_heater_temp|default(100)|float %}    

    # –¢–µ–∫—É—â–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è
    {% set current_heater_temp = printer["heater_generic iHeater_H"].temperature %}

    # –¢–µ–∫—É—â–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–∑–¥—É—Ö–∞ –≤ –∫–∞–º–µ—Ä–µ (—Å —Ç–µ—Ä–º–æ–¥–∞—Ç—á–∏–∫–∞)
    {% set chamber_temp = printer["temperature_sensor iHeater_Sens_C"].temperature %}

    {% if target_heater_temp > 0 %}
        # –ù–∞–≥—Ä–µ–≤ –∞–∫—Ç–∏–≤–µ–Ω

        {% set temp_diff = target_chamber_temp - chamber_temp %}
        {% set adjustment_step = [(delta / 10.0), 1] | max %}

        {% if temp_diff > 1 %}
            # –ö–∞–º–µ—Ä–∞ —Ö–æ–ª–æ–¥–Ω–µ–µ —Ü–µ–ª–µ–≤–æ–π, –ø–ª–∞–≤–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è
            {% set target_heater_temp = target_heater_temp + adjustment_step %}
            
        {% elif temp_diff < -1 %}
            # –ö–∞–º–µ—Ä–∞ –≥–æ—Ä—è—á–µ–µ —Ü–µ–ª–µ–≤–æ–π, –ø–ª–∞–≤–Ω–æ —É–º–µ–Ω—å—à–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è
            {% set target_heater_temp = target_heater_temp - adjustment_step %}
        {% endif %}

        # –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—ã—Ö–æ–¥–∞ –∑–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –ø—Ä–µ–¥–µ–ª—ã:
        {% if target_heater_temp > max_heater_temp %}
            RESPOND TYPE=warning MSG="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—É—é. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ {max_heater_temp}¬∞C"
            {% set target_heater_temp = max_heater_temp %}
        {% elif target_heater_temp < target_chamber_temp %}
            {% set target_heater_temp = target_chamber_temp %}
        {% endif %}
    
        # {% if target_heater_temp < 0 %}
        #     {% set target_heater_temp = 0 %}
        # {% endif %}

        SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=heater_target VALUE={target_heater_temp}
        SET_HEATER_TEMPERATURE HEATER=iHeater_H TARGET={target_heater_temp}

        UPDATE_DELAYED_GCODE ID=_iHEATER_CONTROL DURATION=1

    {% elif current_heater_temp > 50 %}
        # –ù–∞–≥—Ä–µ–≤ –≤—ã–∫–ª—é—á–µ–Ω, –Ω–æ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –æ—Å—Ç—ã–ª
        RESPOND prefix="iHeater_OFF" msg="–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è..."
        UPDATE_DELAYED_GCODE ID=_iHEATER_CONTROL DURATION=1

    {% else %}
        # –ù–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—å –æ—Å—Ç—ã–ª ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ–º –º–∞–∫—Ä–æ—Å
        RESPOND prefix="iHeater_control" msg="–ù–∞–≥—Ä–µ–≤ –∫–∞–º–µ—Ä—ã –∑–∞–≤–µ—Ä—à—ë–Ω."
        UPDATE_DELAYED_GCODE ID=_iHEATER_CONTROL DURATION=0
    {% endif %}