
# О проекте iHeater

iHeater — это компактное и доступное решение для 3D-принтеров без активной термокамеры или с ограниченными возможностями подключения к материнской плате. Он особенно полезен для моделей с проприетарными платами, где нет свободных разъёмов для вентилятора, нагревателя или термистора. iHeater решает эту задачу простым и универсальным способом.

Может работать самостоятельно с собственной прошивкой как отдельное устройство или под управлением Klipper с подключением к принтеру по USB

![PCB](img/PCB_r2.png)

**Под управлением Klipper**

Плата работает как отдельный MCU в Klipper, полностью автономно управляя нагревом камеры и вентилятором. Благодаря питанию от 220 В, iHeater не нагружает блок питания принтера, что особенно важно, учитывая, что штатные БП часто работают на пределе.

Стоимость платы сопоставима или даже ниже, чем самостоятельная сборка аналогичного решения на базе обычного микроконтроллера, твердотельного реле и других необходимых комплектующих. Тем не менее, для энтузиастов остаётся возможность собрать аналог самостоятельно.

iHeater — это простой способ добавить нагрев камеры в ваш принтер, для повышения качества печати и расширения диапазона применяемых материалов.

**С прошивкой iHeater**

Плата iHeater является самодостаточной и имеет всю необходимую периферию и интерфейс управления и отображения для использования как самостоятельное устройство. Необходимая температура задается последовательным нажатием кнопки MODE, а выбранная температура кодируется и отображается тремя светодиодами. Приращение можно изменить в прошивке.

Нажатие |LED1 |LED2 |LED3 | °C |BIN |DEC
-|-|-|-|-|-|-
1	|0	|0	|1	|45 °C	|0b001	|1
2	|0	|1	|0	|50 °C	|0b010	|2
3	|0	|1	|1	|55 °C	|0b011	|3
4	|1	|0	|0	|60 °C	|0b100	|4
5	|1	|0	|1	|65 °C	|0b101	|5
6	|1	|1	|0	|70 °C	|0b110	|6
7	|1	|1	|1	|75 °C	|0b111	|7


# Конфигурация iHeater для Klipper

Данный репозиторий содержит конфигурационные файлы для нагревателя камеры 3D-принтера iHeater на основе прошивки Klipper и одноименной платы управления. Конфигурация предназначена для управления нагревом камеры и вентиляторами с помощью микроконтроллера iHeater.


## Оглавление

- [Требования](#требования)
- [Подготовка](#подготовка)
- [Установка прошивки на iHeater](#установка-прошивки-на-iheater)
- [Конфигурация Klipper](#конфигурация-klipper)
  - [Подключение MCU `iHeater`](#1-подключение-mcu-iheater)
- [Использование](#использование)
  - [Команды управления нагревом камеры](#команды-управления-нагревом-камеры)
  - [Автоматизация и логика управления](#автоматизация-и-логика-управления)
- [Примечания](#примечания)
- [Лицензия](#лицензия)

## Требования

- **Аппаратное обеспечение:**
  - Плата управления iHeater
  - Терморезисторы NTC 100K 3950 (2 шт.)
  - PTC нагревательный элемент 220В 100Вт, для камеры
  - Вентилятор 7530 220В, для циркуляции воздуха в камере
  - Термофьюз KSD9700 или аналогичный (220В 5А 130С)

- **Программное обеспечение:**
  - Klipper (последняя версия)
  - Настроенный и работающий хост с Klipper

## Подготовка

1. **Сборка аппаратной части:**
   - Подключите нагревательный элемент и вентиляторы к iHeater.
   - Подключите KSD в соответствующий разъем.
   - Установите терморезисторы в камере и подключите их к соответствующим пинам MCU.
   - Убедитесь в правильности подключения пинов согласно конфигурационному файлу.

2. **Установка необходимых файлов:**
   - Скопируйте файл iHeater.cfg в директорию конфигурации Klipper.

## Установка прошивки на iHeater

1. **Соберите прошивку Klipper для stm32f042:**

   cd klipper/
   make menuconfig


2. **В меню конфигурации выберите:**

    Enable extra low-level configuration options
    
    Micro-controller Architecture (STMicroelectronics STM32)

    Processor model (STM32F042)

    Bootloader offset (8KiB bootloader)

    Clock Reference (Internal clock)

    Communication interface (USB (on PA9/PA10))

3. **Выключите все лишнее**

        [*] Support GPIO "bit-banging" devices
        [ ] Support LCD devices
        [ ] Support thermocouple MAX sensors
        [ ] Support adxl accelerometers
        [ ] Support lis2dw and lis3dh 3-axis accelerometers
        [ ] Support MPU accelerometers
        [ ] Support HX711 and HX717 ADC chips
        [ ] Support ADS 1220 ADC chip
        [ ] Support ldc1612 eddy current sensor
        [ ] Support angle sensors
        [*] Support software based I2C "bit-banging"
        [ ] Support software based SPI "bit-banging"


4. Сохраните и выйдите из меню.

5. Скомпилируйте прошивку:

        make clean
        make

    !!! Результат должен выглядеть так:

        Creating hex file out/klipper.bin

6. Установка прошивки на плату iHeater:

    При необходимости установите python3-serial
        
        sudo apt install python3-serial

    !!! Далее рассматривается вариант установки с установленным бутлоадером Katapult```

- Подключите iHeater к хосту в режиме программирования (удерживая кнопку Mode при подключении или дважды нажав RESET).

- Выполните поиск 

        ls /dev/serial/by-id/

    !!! Результат должен выглядеть так:

        usb-katapult_stm32f042x6_0C0018000D53304347373020-if00

- Измените на ID свой и введите:
    
        python3 ~/katapult/scripts/flashtool.py -d /dev/serial/by-id/usb-katapult_stm32f042x6_0C0018000D53304347373020-if00 -f ~/klipper/out/klipper.bin

    !!! Результат должен выглядеть так:

        Flashing '/home/pi/klipper/out/klipper.bin'...

        [##################################################]
        
        Write complete: 20 pages

        Verifying (block count = 319)...

        [##################################################]

        Verification Complete: SHA = 8A3DDF39A0E70B684DC6BAF74EF8F089EBDD6C18

        Flash Success

- Проверьте: 
        
            ls /dev/serial/by-id/

    !!! Результат должен выглядеть так:
        usb-Klipper_stm32f042x6_0C0018000D53304347373020-if00

    ```iHeater готов для работы с Klipper```

## Конфигурация пинов

| Pin    | Alias       | Function                          |
|--------|-------------|-----------------------------------|
| PA0    | TH1         | Температурный датчик камеры       |
| PA1    | HEATER      | Управление нагревателем           |
| PA2    | FAN         | Управление вентилятором           |
| PA3    | TH0         | Температурный датчик нагревателя  |
| PA4    | MODE        | Кнопка режима                     |
| PA5    | LED3        | Светодиод 3                       |
| PA6    | LED2        | Светодиод 2                       |
| PA7    | LED1        | Светодиод 1                       |


## Конфигурация Klipper

Скопируйте конфигурационные файлы iHeater.cfg в папку с файлом printer.cfg и подключите его в printer.cfg с помощью директивы [include]
        
    [include iHeater.cfg]

### 1. Подключение MCU iHeater

- Измените файл iHeater.cfg, укажите полученный ID

        [mcu iHeater]
        serial: usb-Klipper_stm32f042x6_0C0018000D53304347373020-if000

## Использование
### Команды управления нагревом камеры
- Установка температуры камеры:
 

        M141 S60  ; Устанавливает температуру камеры на 60°C

- Ожидание достижения температуры:

        M191 S60  ; Ждет, пока температура камеры достигнет 60°C

- Остановка нагрева камеры:

        M141 S0   ; Отключает нагрев камеры

- В завершении G-кода слайсера добавьте `M141 S0`, чтобы корректно отключить нагрев камеры.


## Примечания
- Безопасность:

    - Убедитесь, что все подключения выполнены правильно и безопасно.
    - Проверьте, что значения min_temp и max_temp соответствуют спецификациям оборудования.

- Проверка оборудования:
    - Перед использованием протестируйте работу нагревателя и вентилятора.
    - Следите за температурой во время первых запусков.
- Настройка PID:
    - При необходимости выполните калибровку PID для точного контроля температуры.


## Лицензия
Данный проект распространяется под лицензией MIT. Подробности смотрите в файле LICENSE.


>⚠️  ** Внимание: Использование нагревательных элементов и управление температурой связано с риском возгорания и повреждения оборудования. Всегда следуйте рекомендациям производителя и соблюдайте меры предосторожности.